<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>115å¹´å¥‡ç¾é†«é™¢ç¬¬ä¸€æ¬¡é†«å­¸è‡¨åºŠæŠ€èƒ½æ¸¬é©—(OSCE)è©¦å‹™é€²åº¦å„€è¡¨æ¿</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Custom glass colors
                        glass: {
                            100: 'rgba(255, 255, 255, 0.05)',
                            200: 'rgba(255, 255, 255, 0.1)',
                            300: 'rgba(255, 255, 255, 0.15)',
                            border: 'rgba(255, 255, 255, 0.1)',
                        }
                    },
                    boxShadow: {
                        'glass': '0 4px 30px rgba(0, 0, 0, 0.1)',
                        'glow': '0 0 10px rgba(59, 130, 246, 0.5)',
                        'glow-sm': '0 0 5px rgba(59, 130, 246, 0.3)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            /* æ›´æ·±çš„èƒŒæ™¯æ¼¸å±¤ */
            background: radial-gradient(circle at top left, #0f172a, #020617, #000000);
            background-attachment: fixed;
            color: #f1f5f9; /* é è¨­æ–‡å­—æ›´äº® */
            min-height: 100vh;
        }
        
        /* Glass Effect Utilities - Slightly Darker for Contrast */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6); /* æ›´æ·±çš„ç»ç’ƒåº•è‰² */
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15); /* é‚Šæ¡†äº®ä¸€é»é»å¢åŠ ç«‹é«”æ„Ÿ */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        
        .glass-panel-light {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-header {
            background: rgba(2, 6, 23, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        
        .print-hide { @media print { display: none; } }
        
        /* Mobile Select */
        select.dark-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23e2e8f0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* Background Ambient Orbs - Dimmed */
        .ambient-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(100px);
            z-index: -1;
            opacity: 0.25; /* é™ä½å…‰æšˆäº®åº¦ä»¥å‡¸é¡¯æ–‡å­— */
        }
        .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #1e40af; animation: float 10s infinite; }
        .orb-2 { bottom: -20%; right: -10%; width: 60vw; height: 60vw; background: #4f46e5; animation: float 15s infinite reverse; }

    </style>
</head>
<body>
    <div class="ambient-orb orb-1"></div>
    <div class="ambient-orb orb-2"></div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Configuration ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyMAkQlX4o6sjc0x8dp852YWxL4FuUyNs5taO7SORl4x_-Feig5vJOojAKio9_BTjYFGw/exec";
        
        // --- Icons ---
        const Icons = {
            Calendar: <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" />,
            CheckCircle2: <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM7.5 12.002l3.693 3.693L17.5 8.307" />, 
            AlertCircle: <><circle cx="12" cy="12" r="10" /><path d="M12 8v4M12 16h.01" /></>,
            Printer: <><path d="M6 9V2h12v7M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><path d="M6 14h12v8H6z" /></>,
            LayoutDashboard: <><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></>,
            ListTodo: <><rect x="3" y="5" width="6" height="6" rx="1" /><path d="m3 17 2 2 4-4" /><path d="M13 6h8" /><path d="M13 12h8" /><path d="M13 18h8" /></>,
            FileInput: <><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4" /><path d="M14 2v6h6" /><path d="M2 15h10" /><path d="m9 18 3-3-3-3" /></>,
            ChevronRight: <path d="m9 18 6-6-6-6" />,
            Flag: <><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" /><line x1="4" x2="4" y1="22" y2="15" /></>,
            Clock: <><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /><polyline points="12 6 12 12 16 14" /></>,
            PieChart: <><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></>,
            Send: <><path d="m22 2-7 20-4-9-9-4Z" /><path d="M22 2 11 13" /></>,
            ArrowRight: <><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></>,
            Timer: <><line x1="10" x2="14" y1="2" y2="2" /><line x1="12" x2="15" y1="14" y2="11" /><circle cx="12" cy="14" r="8" /></>,
            Menu: <><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></>,
            X: <><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>,
            Cloud: <path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.9-2.4-5.2-5.3-5.2-2.5 0-4.6 1.8-5.2 4.2C1.1 15.5 0 16.9 0 18.5 0 21 2 23 4.5 23h13c1.7 0 3-1.3 3-3V19z" transform="translate(1,1)" />,
            Save: <><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></>,
            Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></>,
            Copy: <><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
            UploadCloud: <><polyline points="16 16 12 12 8 16" /><line x1="12" x2="12" y1="12" y2="21" /><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3" /><polyline points="16 16 12 12 8 16" /></>,
            DownloadCloud: <><polyline points="8 17 12 21 16 17" /><line x1="12" x2="12" y1="12" y2="21" /><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29" /></>,
            Check: <polyline points="20 6 9 17 4 12" />,
            Lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></>,
            User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
            RefreshCw: <><path d="M21 2v6h-6" /><path d="M3 12a9 9 0 0 1 15-6.7L21 8" /><path d="M3 22v-6h6" /><path d="M21 12a9 9 0 0 1-15 6.7L3 16" /></>,
            Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></>,
            GraduationCap: <path d="M22 10v6M2 10l10-5 10 5-10 5z" />,
            Stethoscope: <path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3" />
        };

        const Icon = ({ name, size = 24, className }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {Icons[name]}
            </svg>
        );

        // --- Data ---
        // ç§»é™¤ Mock æ—¥æœŸï¼Œæ”¹ç‚ºç³»çµ±å‹•æ…‹æ—¥æœŸ
        // å¦‚æœéœ€è¦æ¸¬è©¦ç‰¹å®šæ—¥æœŸï¼Œå¯ä»¥å–æ¶ˆè¨»è§£ä¸‹ä¸€è¡Œä¸¦ä¿®æ”¹æ—¥æœŸ
        // const DEBUG_DATE = new Date('2026-01-28'); 
        
        const STAGES = [
            { id: 1, title: 'ç¬¬ä¸€éšæ®µï¼šç±Œå‚™èˆ‡å ±å', period: '1æœˆ', returnDate: '115.1.28', category: 'official' },
            { id: 2, title: 'ç¬¬äºŒéšæ®µï¼šè©¦å‹™å®‰æ’', period: '2-4æœˆ', returnDate: '115.4.10', category: 'official' },
            { id: 3, title: 'ç¬¬ä¸‰éšæ®µï¼šè€ƒå ´è¨­ç½®èˆ‡åŸ·è¡Œ', period: '4-5æœˆ', returnDate: '115.5.6', category: 'official' },
            { id: 4, title: 'ç¬¬å››éšæ®µï¼šæˆç¸¾çµç®—èˆ‡æª¢è¨', period: '5-6æœˆ', returnDate: '115.6.18', category: 'official' },
            { id: 99, title: 'ğŸ¥ é™¢å…§ UGY åœ‹è€ƒç‰¹è¨“', period: '1-4æœˆ', returnDate: 'å…§éƒ¨è¡Œç¨‹', category: 'internal' },
        ];
        
        const initialTasks = [
            { id: '1-1', stage: 1, seq: '(ä¸€)', taskName: 'å·¥ä½œåŠ/è¨“ç·´èª²ç¨‹ç±Œè¾¦', dateStart: '2025-01-01', dateEnd: '2025-12-31', deadlineDisplay: '114.1~12', completed: false, type: 'task', userNote: '' },
            { id: '1-2', stage: 1, seq: '(äºŒ)', taskName: 'è€ƒå®˜ã€æ¨™æº–åŒ–ç—…äººé´é¸', dateStart: '2025-08-01', dateEnd: '2025-12-31', deadlineDisplay: '114.8~12', completed: false, type: 'task', userNote: '' },
            { id: '1-3', stage: 1, seq: '(ä¸‰)', taskName: 'å¯„äº¤è€ƒå®˜ã€SPèªè­‰ç›¸é—œæ–‡ä»¶', dateStart: '2025-11-30', dateEnd: '2025-11-30', deadlineDisplay: '114.11.30', completed: false, type: 'submission', userNote: '' },
            { id: '1-4', stage: 1, seq: '(å››)', taskName: 'è€ƒè©¦å…¬å‘Š (éœ€æª¢é™„ç•«é¢)', dateStart: '2026-01-12', dateEnd: '2026-01-23', deadlineDisplay: '115.1.12~23', completed: false, type: 'milestone', userNote: '' },
            { id: '1-5', stage: 1, seq: '(äº”)', taskName: 'è€ƒç”Ÿå ±åä½œæ¥­', dateStart: '2026-01-19', dateEnd: '2026-01-23', deadlineDisplay: '115.1.19~23', completed: false, type: 'task', note: 'æ‡‰å±†èˆ‡åœ‹å…§å¤–ç•¢æ¥­ç”Ÿ', userNote: '' },
            { id: '1-6', stage: 1, seq: '(å…­)', taskName: 'å¯„äº¤è€ƒè©¦æ™‚ç¨‹å¿—é¡˜è¡¨', dateStart: '2026-01-28', dateEnd: '2026-01-28', deadlineDisplay: '115.1.28', completed: false, type: 'submission', userNote: '' },
            { id: '1-7', stage: 1, seq: '(ä¸ƒ)', taskName: 'å›å ±å ±åè€ƒç”Ÿå„æ¢¯æ¬¡äººæ•¸', dateStart: '2026-01-28', dateEnd: '2026-01-28', deadlineDisplay: '115.1.28', completed: false, type: 'submission', userNote: '' },
            { id: '1-end', stage: 1, seq: 'â˜…', taskName: 'å›å‚³ç¬¬ä¸€éšæ®µè©¦å‹™æµç¨‹æª¢æ ¸è¡¨', dateStart: '2026-01-28', dateEnd: '2026-01-28', deadlineDisplay: '115.1.28', completed: false, type: 'submission', note: 'æœ¬éšæ®µçµæ¡ˆé—œéµ', userNote: '' },
            
            { id: '2-1', stage: 2, seq: '(ä¸€)', taskName: 'å…¬å‘Šè€ƒç”Ÿæ¢¯æ¬¡åå–®å‰å…ˆé€å­¸æœƒæ ¸å¯', dateStart: '2026-02-01', dateEnd: '2026-02-28', deadlineDisplay: '115.2', completed: false, type: 'task', userNote: '' },
            { id: '2-2', stage: 2, seq: '(äºŒ)', taskName: 'å¯„äº¤å„æ¢¯æ¬¡è€ƒç”Ÿåå–®(å«è­‰æ˜æƒææª”)', dateStart: '2026-02-13', dateEnd: '2026-02-13', deadlineDisplay: '115.2.13', completed: false, type: 'submission', userNote: '' },
            { id: '2-3', stage: 2, seq: '(ä¸‰)', taskName: 'æå ±æ ¡å¤–è€ƒå®˜åå–®', dateStart: '2026-03-04', dateEnd: '2026-03-04', deadlineDisplay: '115.3.4', completed: false, type: 'submission', userNote: '' },
            { id: '2-4', stage: 2, seq: '(å››)', taskName: 'å¯„ç™¼å‡†è€ƒè­‰', dateStart: '2026-03-16', dateEnd: '2026-03-20', deadlineDisplay: '115.3.16~20', completed: false, type: 'milestone', userNote: '' },
            { id: '2-5', stage: 2, seq: '(äº”)', taskName: 'ç¢ºèªæ ¡å¤–è€ƒå®˜æ’ç­æ™‚é–“', dateStart: '2026-04-10', dateEnd: '2026-04-10', deadlineDisplay: '115.4.10', completed: false, type: 'task', userNote: '' },
            { id: '2-6', stage: 2, seq: '(å…­)', taskName: 'ç¢ºèªæ ¡å…§è€ƒå®˜æ’ç­æ™‚é–“', dateStart: '2026-04-10', dateEnd: '2026-04-10', deadlineDisplay: '115.4.10', completed: false, type: 'task', userNote: '' },
            { id: '2-7', stage: 2, seq: '(ä¸ƒ)', taskName: 'ç¢ºèªå¤–æ´¾è€ƒå®˜æ’ç­/ç°½ç½²é ˆçŸ¥', dateStart: '2026-04-10', dateEnd: '2026-04-10', deadlineDisplay: '115.4.10', completed: false, type: 'task', userNote: '' },
            { id: '2-end', stage: 2, seq: 'â˜…', taskName: 'å›å‚³ç¬¬äºŒéšæ®µè©¦å‹™æµç¨‹æª¢æ ¸è¡¨', dateStart: '2026-04-10', dateEnd: '2026-04-10', deadlineDisplay: '115.4.10', completed: false, type: 'submission', note: 'æœ¬éšæ®µçµæ¡ˆé—œéµ', userNote: '' },
            
            { id: '3-1', stage: 3, seq: '(ä¸€)', taskName: 'æ¨™æº–åŒ–ç—…äººæ’ç­', dateStart: '2026-04-20', dateEnd: '2026-04-20', deadlineDisplay: '115.4.20', completed: false, type: 'task', userNote: '' },
            { id: '3-2', stage: 3, seq: '(äºŒ)', taskName: 'å‚™ç½®å¸¸å‚™/æ“ä½œæŠ€èƒ½é“å…·åŒ…', dateStart: '2026-04-20', dateEnd: '2026-04-20', deadlineDisplay: '115.4.20', completed: false, type: 'task', userNote: '' },
            { id: '3-3', stage: 3, seq: '(ä¸‰)', taskName: 'é ˜å–è€ƒé¡Œ (æ“‡æ—¥æœƒè­°)', dateStart: '2026-04-20', dateEnd: '2026-04-22', deadlineDisplay: '115.4.20~22', completed: false, type: 'task', userNote: '' },
            { id: '3-4', stage: 3, seq: '(å››)', taskName: 'ç¶²è·¯é€£ç·šæ¸¬è©¦', dateStart: '2026-04-20', dateEnd: '2026-04-23', deadlineDisplay: '115.4.20~23', completed: false, type: 'task', userNote: '' },
            { id: '3-5', stage: 3, seq: '(äº”)', taskName: 'ç¢ºèªè€ƒå ´è¨ºé–“éŒ„å½±éŸ³è¨­å‚™åŠŸèƒ½', dateStart: '2026-04-24', dateEnd: '2026-05-03', deadlineDisplay: 'è€ƒè©¦ç•¶é€±', completed: false, type: 'task', userNote: '' },
            { id: '3-6', stage: 3, seq: '(å…­)', taskName: 'è€ƒå ´ä½ˆç½® (è€ƒå‰äºŒæ—¥)', dateStart: '2026-04-22', dateEnd: '2026-04-22', deadlineDisplay: 'è€ƒå‰äºŒæ—¥', completed: false, type: 'task', userNote: '' },
            { id: '3-7', stage: 3, seq: '(ä¸ƒ)', taskName: 'è€ƒå‰æª¢é–± (è€ƒå‰ä¸€æ—¥)', dateStart: '2026-04-23', dateEnd: '2026-04-23', deadlineDisplay: 'è€ƒå‰ä¸€æ—¥', completed: false, type: 'task', userNote: '' },
            { id: '3-8', stage: 3, seq: '(å…«)', taskName: 'äººå“¡å‡ºå¸­ç¢ºèª (è€ƒå‰ä¸€æ—¥)', dateStart: '2026-04-23', dateEnd: '2026-04-23', deadlineDisplay: 'è€ƒå‰ä¸€æ—¥', completed: false, type: 'task', userNote: '' },
            { id: '3-9', stage: 3, seq: '(ä¹)', taskName: 'è€ƒå®˜åƒèˆ‡è©•åˆ†å…±è­˜æœƒè­° (è€ƒè©¦æ—¥)', dateStart: '2026-04-24', dateEnd: '2026-05-03', deadlineDisplay: 'è€ƒè©¦æ—¥', completed: false, type: 'milestone', userNote: '' },
            { id: '3-10', stage: 3, seq: '(å)', taskName: 'SPåƒèˆ‡æ¼”å‡ºä¸€è‡´æ€§è¨“ç·´ (è€ƒè©¦æ—¥)', dateStart: '2026-04-24', dateEnd: '2026-05-03', deadlineDisplay: 'è€ƒè©¦æ—¥', completed: false, type: 'task', userNote: '' },
            { id: '3-11', stage: 3, seq: '(åä¸€)', taskName: 'è€ƒç”Ÿæˆç¸¾çµ±è¨ˆå¯„äº¤', dateStart: '2026-04-29', dateEnd: '2026-05-06', deadlineDisplay: 'è€ƒç•¢3æ—¥å…§', completed: false, type: 'submission', userNote: '' },
            { id: '3-end', stage: 3, seq: 'â˜…', taskName: 'å›å‚³ç¬¬ä¸‰éšæ®µè©¦å‹™æµç¨‹æª¢æ ¸è¡¨', dateStart: '2026-05-06', dateEnd: '2026-05-06', deadlineDisplay: '115.5.6', completed: false, type: 'submission', note: 'æœ¬éšæ®µçµæ¡ˆé—œéµ', userNote: '' },
            
            { id: '4-1', stage: 4, seq: '(ä¸€)', taskName: 'å¯„äº¤å•å·ã€è©•æ ¸è¡¨ã€æˆæœç…§ç‰‡', dateStart: '2026-05-08', dateEnd: '2026-05-08', deadlineDisplay: '115.5.8', completed: false, type: 'submission', userNote: '' },
            { id: '4-2', stage: 4, seq: '(äºŒ)', taskName: 'å‹•å“¡äººæ•¸çµ±è¨ˆ', dateStart: '2026-05-08', dateEnd: '2026-05-08', deadlineDisplay: '115.5.8', completed: false, type: 'task', userNote: '' },
            { id: '4-3', stage: 4, seq: '(ä¸‰)', taskName: 'ç¹³äº¤åŠæ ¼åˆ¤å®šè¡¨ã€ç¢ºèªåŠæ ¼åå–®', dateStart: '2026-05-22', dateEnd: '2026-05-22', deadlineDisplay: '115.5.22', completed: false, type: 'submission', userNote: '' },
            { id: '4-4', stage: 4, seq: '(å››)', taskName: 'æˆç¸¾å–®å¯„ç™¼', dateStart: '2026-05-26', dateEnd: '2026-05-26', deadlineDisplay: '115.5.26', completed: false, type: 'milestone', userNote: '' },
            { id: '4-5', stage: 4, seq: '(äº”)', taskName: 'æˆç¸¾è¤‡æŸ¥çµæœé€šçŸ¥', dateStart: '2026-05-29', dateEnd: '2026-05-29', deadlineDisplay: '115.5.29', completed: false, type: 'task', userNote: '' },
            { id: '4-6', stage: 4, seq: '(å…­)', taskName: 'å‡½é€åŠæ ¼åˆ¤å®šè¡¨ (ç´™æœ¬)', dateStart: '2026-05-29', dateEnd: '2026-05-29', deadlineDisplay: '115.5.29', completed: false, type: 'submission', userNote: '' },
            { id: '4-7', stage: 4, seq: '(ä¸ƒ)', taskName: 'ç¹³äº¤æˆç¸¾è¤‡æŸ¥è€ƒç”ŸéŒ„å½±éŸ³æª”', dateStart: '2026-06-04', dateEnd: '2026-06-04', deadlineDisplay: '115.6.4', completed: false, type: 'submission', note: 'è‹¥ç„¡è¤‡æŸ¥å¯ç•¥', userNote: '' },
            { id: '4-8', stage: 4, seq: '(å…«)', taskName: 'åŠæ ¼è­‰æ˜å¯„ç™¼', dateStart: '2026-06-17', dateEnd: '2026-06-18', deadlineDisplay: '115.6.17~18', completed: false, type: 'milestone', userNote: '' },
            { id: '4-end', stage: 4, seq: 'â˜…', taskName: 'å›å‚³ç¬¬å››éšæ®µè©¦å‹™æµç¨‹æª¢æ ¸è¡¨', dateStart: '2026-06-18', dateEnd: '2026-06-18', deadlineDisplay: '115.6.18', completed: false, type: 'submission', note: 'è©¦å‹™å·¥ä½œçµæ¡ˆ', userNote: '' },
            
            // --- é™¢å…§ç‰¹è¨“ä»»å‹™ (Stage 99) ---
            { id: 'int-1', stage: 99, seq: '1', taskName: 'æ•™å­¸å‹ OSCE æ¸¬é©—', dateStart: '2026-01-24', dateEnd: '2026-01-24', deadlineDisplay: '115.1.24 (å…­)', completed: false, type: 'training', note: 'UGY å°è±¡', userNote: '' },
            { id: 'int-2', stage: 99, seq: '2', taskName: 'é«˜éšå‹ OSCE æ¸¬é©— (ç¬¬ä¸€æ¢¯)', dateStart: '2026-03-21', dateEnd: '2026-03-21', deadlineDisplay: '115.3.21 (å…­)', completed: false, type: 'training', note: '', userNote: '' },
            { id: 'int-3', stage: 99, seq: '3', taskName: 'è‡¨åºŠæŠ€èƒ½æ“ä½œåœ‹è€ƒè¤‡ç¿’ç­', dateStart: '2026-03-25', dateEnd: '2026-03-25', deadlineDisplay: '115.3.25 (ä¸‰)', completed: false, type: 'training', note: '', userNote: '' },
            { id: 'int-4', stage: 99, seq: '4', taskName: 'é«˜éšå‹ OSCE æ¸¬é©— (ç¬¬äºŒæ¢¯)', dateStart: '2026-03-28', dateEnd: '2026-03-28', deadlineDisplay: '115.3.28 (å…­)', completed: false, type: 'training', note: '', userNote: '' },
            { id: 'int-5', stage: 99, seq: '5', taskName: 'èº«é«”ç†å­¸æª¢æŸ¥æ•™å­¸å‹ OSCE', dateStart: '2026-04-11', dateEnd: '2026-04-11', deadlineDisplay: '115.4.11 (å…­)', completed: false, type: 'training', note: '', userNote: '' },
        ];

        // --- Custom Components ---
        const Modal = ({ isOpen, onClose, title, children, footer }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative glass-panel rounded-xl shadow-2xl w-full max-w-md p-6 animate-slide-up border-0">
                        <div className="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                            <h3 className="text-xl font-bold text-white">{title}</h3>
                            <button onClick={onClose} className="text-slate-300 hover:text-white transition-colors">
                                <Icon name="X" size={24} />
                            </button>
                        </div>
                        <div className="text-slate-200 mb-6 font-bold">
                            {children}
                        </div>
                        {footer && (
                            <div className="flex justify-end gap-3">
                                {footer}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const Notification = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgClass = type === 'success' ? 'bg-emerald-600/90 border-emerald-500' : 'bg-red-600/90 border-red-500';

            return (
                <div className={`fixed bottom-6 right-6 ${bgClass} border text-white px-6 py-3 rounded-lg shadow-glow backdrop-blur-md flex items-center gap-3 animate-fade-in z-50 font-bold`}>
                    <Icon name={type === 'success' ? 'Check' : 'AlertCircle'} size={20} />
                    <span className="font-bold">{message}</span>
                </div>
            );
        };

        const LoginModal = ({ isOpen, onClose, onLogin }) => {
            const [personnelId, setPersonnelId] = useState("");
            const [error, setError] = useState("");
            const [isValidating, setIsValidating] = useState(false);

            if (!isOpen) return null;

            const handleSubmit = () => {
                if (!personnelId.trim()) {
                    setError("è«‹è¼¸å…¥äººäº‹è™Ÿ");
                    return;
                }
                
                setIsValidating(true);
                setError("");

                const script = document.createElement('script');
                const callbackName = 'loginCallback_' + Date.now();
                
                window[callbackName] = (response) => {
                    setIsValidating(false);
                    if (response.status === 'success') {
                        onLogin(personnelId);
                        onClose();
                    } else {
                        setError(response.message || "é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥äººäº‹è™Ÿ");
                    }
                    delete window[callbackName];
                    document.body.removeChild(script);
                };

                script.onerror = () => {
                    setIsValidating(false);
                    setError("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Script éƒ¨ç½²ç‹€æ…‹");
                    delete window[callbackName];
                    document.body.removeChild(script);
                };

                script.src = `${GOOGLE_SCRIPT_URL}?action=login&id=${encodeURIComponent(personnelId)}&callback=${callbackName}`;
                document.body.appendChild(script);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative glass-panel rounded-xl shadow-2xl w-full max-w-sm p-6 animate-slide-up border-0">
                        <div className="flex justify-between items-center mb-6 border-b border-white/10 pb-3">
                            <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                <Icon name="Lock" size={20} className="text-indigo-400"/> ç®¡ç†å“¡ç™»å…¥
                            </h3>
                            <button onClick={onClose} className="text-slate-300 hover:text-white"><Icon name="X" size={24} /></button>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs text-slate-300 mb-1.5 uppercase font-bold tracking-wider">äººäº‹è™Ÿ (ID)</label>
                                <input 
                                    type="password" 
                                    className="w-full bg-black/30 border border-white/10 rounded-lg px-4 py-2 text-white font-bold focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all placeholder-slate-500"
                                    placeholder="â—â—â—â—â—â—"
                                    value={personnelId}
                                    onChange={(e) => {setPersonnelId(e.target.value); setError("");}}
                                    onKeyDown={(e) => e.key === 'Enter' && handleSubmit()}
                                    disabled={isValidating}
                                />
                            </div>
                            {error && <p className="text-red-400 text-xs flex items-center gap-1 font-bold"><Icon name="AlertCircle" size={12}/> {error}</p>}
                            <div className="pt-2">
                                <button 
                                    onClick={handleSubmit}
                                    disabled={isValidating}
                                    className={`w-full text-white font-bold py-2 rounded-lg transition-all shadow-glow flex items-center justify-center gap-2 ${isValidating ? 'bg-slate-600 cursor-wait' : 'bg-indigo-600 hover:bg-indigo-500 hover:scale-[1.02] active:scale-[0.98]'}`}
                                >
                                    {isValidating ? 'é©—è­‰ä¸­...' : 'é©—è­‰èº«ä»½'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Helper to get Monday and Sunday of the week for a given date
        const getWeekRange = (date) => {
            const d = new Date(date);
            const day = d.getDay(); // 0 (Sun) to 6 (Sat)
            const diffToMon = day === 0 ? -6 : 1 - day; // Adjust so Mon is start
            const monday = new Date(d);
            monday.setDate(d.getDate() + diffToMon);
            monday.setHours(0,0,0,0);
            
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            sunday.setHours(23,59,59,999);
            
            return { start: monday, end: sunday };
        };

        // Helper to calculate days difference properly (ignoring time)
        const getDaysDiff = (targetDate, baseDate) => {
            const t = new Date(targetDate);
            t.setHours(0, 0, 0, 0);
            const b = new Date(baseDate);
            b.setHours(0, 0, 0, 0);
            const diffTime = t.getTime() - b.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        const App = () => {
            // UPDATED: Now uses system Date by default
            const [currentDate, setCurrentDate] = useState(() => {
                if (typeof DEBUG_DATE !== 'undefined') return DEBUG_DATE;
                return new Date();
            });

            useEffect(() => {
                // Optional: Update date every minute to keep it fresh
                const timer = setInterval(() => {
                    if (typeof DEBUG_DATE === 'undefined') {
                        setCurrentDate(new Date());
                    }
                }, 60000);
                return () => clearInterval(timer);
            }, []);

            const [activeStage, setActiveStage] = useState(1);
            const [filter, setFilter] = useState('all');
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [tasks, setTasks] = useState(initialTasks);
            const [isSyncing, setIsSyncing] = useState(false);
            const [isUploading, setIsUploading] = useState(false);
            const [storageLoaded, setStorageLoaded] = useState(false);
            const [isLoadingCloud, setIsLoadingCloud] = useState(false);
            
            const [confirmModal, setConfirmModal] = useState({ isOpen: false, onConfirm: null });
            const [notification, setNotification] = useState(null);
            
            const [currentUser, setCurrentUser] = useState(null); 
            const [showLoginModal, setShowLoginModal] = useState(false);
            const isAdmin = useMemo(() => !!currentUser, [currentUser]); 

            const formRef = useRef(null);

            const STORAGE_KEY = 'osce_dashboard_data_v1';
            const AUTH_KEY = 'osce_dashboard_auth_v1_id'; 

            useEffect(() => {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    try {
                        const parsed = JSON.parse(savedData);
                        if (parsed && Array.isArray(parsed)) {
                            const merged = initialTasks.map(t => {
                                const saved = parsed.find(p => p.id === t.id);
                                return saved ? { ...t, completed: saved.completed, userNote: saved.userNote || '' } : t;
                            });
                            setTasks(merged);
                        }
                    } catch (e) { console.error("Load failed", e); }
                }
                
                const savedAuth = localStorage.getItem(AUTH_KEY);
                if (savedAuth) {
                    setCurrentUser(savedAuth);
                }

                setStorageLoaded(true);
                silentFetchCloudData();
            }, []);

            const silentFetchCloudData = () => {
                setIsLoadingCloud(true);
                const script = document.createElement('script');
                const callbackName = 'loadDataCallback_' + Date.now();
                
                window[callbackName] = (response) => {
                    setIsLoadingCloud(false);
                    if (response.status === 'success') {
                        const cloudData = response.data;
                        
                        setTasks(prevTasks => {
                            const updated = prevTasks.map(t => {
                                if (cloudData.hasOwnProperty(t.taskName)) {
                                    return { 
                                        ...t, 
                                        completed: cloudData[t.taskName].completed,
                                        userNote: cloudData[t.taskName].userNote || '' 
                                    };
                                }
                                return t; 
                            });
                            
                            const toSave = updated.map(t => ({ id: t.id, completed: t.completed, userNote: t.userNote }));
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
                            return updated;
                        });
                        console.log("Cloud data synced successfully");
                    }
                    delete window[callbackName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                };

                script.onerror = () => {
                    setIsLoadingCloud(false);
                    console.error("Auto-sync failed");
                    delete window[callbackName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                };

                script.src = `${GOOGLE_SCRIPT_URL}?action=loadData&callback=${callbackName}`;
                document.body.appendChild(script);
            };

            const handleLogin = (id) => {
                setCurrentUser(id);
                localStorage.setItem(AUTH_KEY, id);
                setNotification({ message: 'ç™»å…¥æˆåŠŸï¼å·²åˆ‡æ›è‡³ç®¡ç†æ¨¡å¼', type: 'success' });
            };

            const handleLogout = () => {
                setCurrentUser(null);
                localStorage.removeItem(AUTH_KEY);
                setNotification({ message: 'å·²ç™»å‡º', type: 'success' });
            };

            const toggleTask = (id) => {
                if (!isAdmin) {
                    setNotification({ message: 'åƒ…ç®¡ç†å“¡å¯ä¿®æ”¹é€²åº¦', type: 'error' });
                    return;
                }
                const newTasks = tasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t);
                setTasks(newTasks);
                setIsSyncing(true);
                const toSave = newTasks.map(t => ({ id: t.id, completed: t.completed, userNote: t.userNote }));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
                setTimeout(() => setIsSyncing(false), 500);
            };

            const updateUserNote = (id, newNote) => {
                const newTasks = tasks.map(t => t.id === id ? { ...t, userNote: newNote } : t);
                setTasks(newTasks);
                const toSave = newTasks.map(t => ({ id: t.id, completed: t.completed, userNote: t.userNote }));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
            };

            const handleSyncClick = () => {
                setConfirmModal({
                    isOpen: true,
                    onConfirm: performSync
                });
            };

            const performSync = async () => {
                setConfirmModal({ isOpen: false, onConfirm: null });
                setIsUploading(true);
                
                try {
                    if (formRef.current) {
                        formRef.current.submit();
                        setTimeout(() => {
                            setIsUploading(false);
                            setNotification({ message: 'åŒæ­¥è«‹æ±‚å·²é€å‡ºï¼', type: 'success' });
                        }, 2000);
                    } else {
                        throw new Error("Form reference missing");
                    }
                } catch (error) {
                    console.error("Sync error:", error);
                    setIsUploading(false);
                    setNotification({ message: 'åŒæ­¥ç™¼ç”ŸéŒ¯èª¤', type: 'error' });
                }
            };

            const copyForGoogleSheets = () => {
                let tsv = "";
                tasks.forEach(t => {
                    const status = t.completed ? "å·²å®Œæˆ" : "æœªå®Œæˆ";
                    const stageName = STAGES.find(s => s.id === t.stage)?.title || "";
                    const safeNote = (t.userNote || "").replace(/\n/g, " ");
                    tsv += `${t.seq}\t${stageName}\t${t.taskName}\t${status}\t${t.deadlineDisplay}\t${t.note || ""}\t${safeNote}\n`;
                });

                const textArea = document.createElement("textarea");
                textArea.value = tsv;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus(); textArea.select();

                try {
                    document.execCommand('copy');
                    setNotification({ message: 'è³‡æ–™å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', type: 'success' });
                } catch (err) {
                    setNotification({ message: 'è¤‡è£½å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™', type: 'error' });
                }
                document.body.removeChild(textArea);
            };

            const downloadCSV = () => {
                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
                csvContent += "é …æ¬¡,éšæ®µ,å·¥ä½œé …ç›®,ç‹€æ…‹,æˆªæ­¢æ—¥æœŸ,å›ºå®šå‚™è¨»,è‡ªè¨‚ç­†è¨˜\n";
                tasks.forEach(t => {
                    const status = t.completed ? "å·²å®Œæˆ" : "æœªå®Œæˆ";
                    const stageName = STAGES.find(s => s.id === t.stage)?.title || "";
                    const safeName = `"${t.taskName.replace(/"/g, '""')}"`;
                    const safeNote = t.note ? `"${t.note.replace(/"/g, '""')}"` : "";
                    const safeUserNote = t.userNote ? `"${t.userNote.replace(/"/g, '""')}"` : "";
                    csvContent += `${t.seq},${stageName},${safeName},${status},${t.deadlineDisplay},${safeNote},${safeUserNote}\n`;
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "OSCE_115_Progress.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Calc
            const examDate = new Date('2026-05-02');
            // UPDATED: Use getDaysDiff helper for cleaner day calculation
            const daysUntilExam = getDaysDiff(examDate, currentDate);
            
            const stats = useMemo(() => {
                const total = tasks.length;
                const completed = tasks.filter(t => t.completed).length;
                const submissionTotal = tasks.filter(t => t.type === 'submission').length;
                const submissionDone = tasks.filter(t => t.type === 'submission' && t.completed).length;
                
                const { start: weekStart, end: weekEnd } = getWeekRange(currentDate);

                // UPDATED Logic for Active Tasks:
                // Filter tasks that are NOT completed AND deadline falls within THIS WEEK (Mon-Sun) OR Overdue
                const activeTasks = tasks.filter(t => {
                    if (t.completed) return false;
                    
                    const end = new Date(t.dateEnd);
                    // Include if due date is <= week end (covers this week and overdue)
                    return end <= weekEnd;
                }).sort((a, b) => new Date(a.dateEnd) - new Date(b.dateEnd));

                // UPDATED Logic for Upcoming Tasks:
                // Tasks starting AFTER this week
                const upcomingTasks = tasks.filter(t => {
                    if (t.completed) return false;
                    const start = new Date(t.dateStart);
                    return start > weekEnd;
                }).sort((a, b) => new Date(a.dateStart).getTime() - new Date(b.dateStart).getTime()).slice(0, 3);
                
                return { total, completed, progress: Math.round((completed / total) * 100), submissionProgress: Math.round((submissionDone / submissionTotal) * 100), activeTasks, upcomingTasks };
            }, [tasks, currentDate]);

            const getTrafficLight = (task) => {
                if (task.completed) return 'bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]'; 
                
                // UPDATED: Use days diff helper
                const daysUntilDeadline = getDaysDiff(task.dateEnd, currentDate);
                
                if (daysUntilDeadline < 0) return 'bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)] animate-pulse'; 
                if (daysUntilDeadline >= 0 && daysUntilDeadline <= 7) return 'bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.5)]'; 
                return 'bg-slate-600/50'; 
            };

            const getStatusLabel = (task) => {
                if (task.completed) return { text: 'å·²å®Œæˆ', class: 'text-emerald-300 bg-emerald-500/20 border-emerald-500/30' };
                
                // UPDATED: Use days diff helper
                const daysUntilDeadline = getDaysDiff(task.dateEnd, currentDate);
                
                if (daysUntilDeadline < 0) return { text: 'å·²é€¾æœŸ', class: 'text-red-300 bg-red-500/20 border-red-500/30' };
                if (daysUntilDeadline === 0) return { text: 'ä»Šå¤©åˆ°æœŸ', class: 'text-amber-300 bg-amber-500/20 border-amber-500/30' };
                if (daysUntilDeadline > 0 && daysUntilDeadline <= 7) return { text: 'å³å°‡åˆ°æœŸ', class: 'text-amber-300 bg-amber-500/20 border-amber-500/30' };
                return { text: 'å¾…è¾¦ä¸­', class: 'text-slate-400 bg-slate-700/50 border-slate-600/30' };
            };

            const ActionCard = ({ task, daysLeft, onToggle }) => (
                <div className="glass-panel-light p-4 md:p-5 rounded-xl flex flex-col md:flex-row md:items-center justify-between group hover:bg-white/5 transition-all gap-4 relative">
                    <div className={`absolute left-0 top-0 bottom-0 w-1 rounded-l-xl ${getTrafficLight(task).includes('red') ? 'bg-red-500' : getTrafficLight(task).includes('amber') ? 'bg-amber-400' : getTrafficLight(task).includes('emerald') ? 'bg-emerald-500' : 'bg-slate-600'}`}></div>
                    <div className="flex items-start gap-4 pl-3">
                        <button onClick={() => onToggle(task.id)} className={`transition-colors mt-1 ${isAdmin ? 'text-slate-400 hover:text-blue-400 cursor-pointer' : 'text-slate-600 cursor-not-allowed opacity-50'}`}>
                            {task.completed ? <Icon name="CheckCircle2" className="text-emerald-400 drop-shadow-md" size={28}/> : <Icon name="CheckCircle2" size={28}/>}
                        </button>
                        <div>
                            <div className="flex items-center gap-2 mb-1">
                                <div className={`w-2.5 h-2.5 rounded-full ${getTrafficLight(task)}`}></div>
                                <div className="font-bold text-slate-100 text-lg md:text-xl leading-snug">{task.taskName}</div>
                            </div>
                            <div className="text-sm md:text-base text-slate-300 font-bold mt-1 flex flex-wrap items-center gap-2">
                                <span className="bg-white/5 px-2 py-0.5 rounded text-slate-200 border border-white/10">{task.seq}</span>
                                <span className="flex items-center gap-1 font-mono font-bold text-xs bg-black/20 px-2 py-1 rounded border border-white/5 text-slate-200"><Icon name="Calendar" size={14}/> {task.deadlineDisplay}</span>
                            </div>
                        </div>
                    </div>
                    <div className="flex md:flex-col items-center md:items-end justify-between md:justify-center w-full md:w-auto pl-12 md:pl-0">
                        {task.type === 'submission' && (
                            <div className="text-xs font-bold text-rose-300 bg-rose-500/10 border border-rose-500/20 px-2 py-1 rounded mb-0 md:mb-1 inline-block backdrop-blur-sm">éœ€å›å‚³</div>
                        )}
                        <div className={`text-lg md:text-xl font-bold whitespace-nowrap ${daysLeft <= 3 ? 'text-rose-400' : 'text-blue-400'} drop-shadow-sm`}>
                             {daysLeft < 0 ? `é€¾æœŸ ${Math.abs(daysLeft)} å¤©` : daysLeft === 0 ? "ä»Šå¤©åˆ°æœŸ" : `å‰© ${daysLeft} å¤©`}
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen font-sans text-slate-200 flex flex-col pb-16 relative">
                    {/* Hidden Form */}
                    <iframe name="hidden_iframe_sync" style={{display: 'none'}}></iframe>
                    <form ref={formRef} action={GOOGLE_SCRIPT_URL} method="post" target="hidden_iframe_sync" style={{display: 'none'}}>
                        <input type="hidden" name="payload" value={JSON.stringify({ tasks: tasks })} />
                    </form>

                    <Modal isOpen={confirmModal.isOpen} onClose={() => setConfirmModal({ ...confirmModal, isOpen: false })} title="ç¢ºèªåŒæ­¥" footer={<><button onClick={() => setConfirmModal({ ...confirmModal, isOpen: false })} className="px-4 py-2 rounded-lg text-slate-300 font-bold hover:bg-white/10 transition-colors">å–æ¶ˆ</button><button onClick={confirmModal.onConfirm} className="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-bold transition-colors shadow-glow-sm">ç¢ºèªåŒæ­¥</button></>}>
                        <p>ç¢ºå®šè¦å°‡ç›®å‰çš„é€²åº¦åŒæ­¥åˆ° Google Sheet å—ï¼Ÿ</p>
                        <p className="text-sm text-slate-400 mt-2 font-bold">æ³¨æ„ï¼šé€™å°‡æœƒè¦†å¯« Google Sheet ä¸Šå°æ‡‰çš„è³‡æ–™ã€‚</p>
                    </Modal>

                    <LoginModal isOpen={showLoginModal} onClose={() => setShowLoginModal(false)} onLogin={handleLogin} />

                    {notification && <Notification message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}

                    {isUploading && (
                        <div className="loading-overlay">
                            <div className="glass-panel p-6 rounded-xl flex flex-col items-center gap-4">
                                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
                                <p className="text-white font-bold">æ­£åœ¨åŒæ­¥è‡³ Google Sheet...</p>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <header className="glass-header sticky top-0 z-20 print-hide">
                        <div className="max-w-7xl mx-auto px-4 md:px-6 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4 w-full md:w-auto">
                                <div className="bg-blue-600 p-2.5 rounded-xl shadow-glow shrink-0">
                                    <Icon name="LayoutDashboard" size={24} className="text-white" />
                                </div>
                                <div>
                                    <h1 className="text-lg md:text-xl font-bold tracking-wide text-white leading-tight drop-shadow-sm">115å¹´å¥‡ç¾é†«é™¢ç¬¬ä¸€æ¬¡é†«å­¸è‡¨åºŠæŠ€èƒ½æ¸¬é©—(OSCE)è©¦å‹™é€²åº¦å„€è¡¨æ¿</h1>
                                    <p className="text-xs md:text-sm text-slate-300 font-bold mt-1 flex items-center gap-2">
                                        <span className={`flex items-center gap-1 px-2 py-0.5 rounded-full border text-xs backdrop-blur-md ${isAdmin ? 'text-emerald-300 bg-emerald-500/10 border-emerald-500/30' : 'text-slate-300 bg-white/5 border-white/10'}`}>
                                            <Icon name={isAdmin ? "Users" : "Lock"} size={12} /> {isAdmin ? "ç®¡ç†å“¡æ¨¡å¼" : "è¨ªå®¢æ¨¡å¼ (åƒ…ä¾›æª¢è¦–)"}
                                        </span>
                                        {isAdmin && isSyncing && <Icon name="Save" size={14} className="animate-pulse text-blue-400"/>}
                                        {isLoadingCloud && <span className="flex items-center text-xs text-blue-400 gap-1 ml-2"><Icon name="RefreshCw" size={12} className="animate-spin"/> è®€å–é›²ç«¯è³‡æ–™ä¸­...</span>}
                                    </p>
                                </div>
                            </div>
                            
                            <div className="flex flex-col items-end gap-2 w-full md:w-auto">
                                <div className="text-right text-xs text-slate-300 font-bold bg-white/5 px-3 py-1.5 rounded-lg border border-white/5 hidden md:block backdrop-blur-sm">
                                    ç¶²é ç¶­è­·è€…: æ•™å­¸éƒ¨ ç›§è‹±äº‘ æ•™å­¸è¡Œæ”¿ç®¡ç†å“¡
                                </div>
                                <div className="flex items-center gap-4 justify-between w-full md:justify-end">
                                    <div className="text-right">
                                        <p className="text-xs text-slate-300 font-bold mb-1">
                                            è·é›¢ æ­£å¼åœ‹è€ƒ (4/24)
                                        </p>
                                        <p className="text-4xl md:text-5xl font-mono font-bold text-yellow-400 leading-none drop-shadow-[0_0_15px_rgba(250,204,21,0.5)]">
                                            {daysUntilExam} <span className="text-lg text-slate-400 font-normal">å¤©</span>
                                        </p>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {isAdmin ? (
                                            <button onClick={handleLogout} className="text-xs font-bold bg-white/5 hover:bg-white/10 text-slate-300 px-3 py-1.5 rounded border border-white/10 transition-colors backdrop-blur-sm">ç™»å‡º</button>
                                        ) : (
                                            <button onClick={() => setShowLoginModal(true)} className="text-xs font-bold bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded border border-indigo-500/50 transition-colors flex items-center gap-1 shadow-glow-sm"><Icon name="User" size={12}/> ç™»å…¥</button>
                                        )}
                                        <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="md:hidden p-2 text-slate-300">
                                            {isMobileMenuOpen ? <Icon name="X" size={28}/> : <Icon name="Menu" size={28}/>}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <div className="flex-1 max-w-7xl w-full mx-auto p-4 md:p-6 lg:p-8 space-y-8">
                        {/* Action Center */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8 print-hide">
                            <div className="glass-panel p-5 md:p-6 rounded-2xl relative overflow-hidden group">
                                <div className="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none group-hover:bg-blue-500/20 transition-all duration-700"></div>
                                <h3 className="flex items-center gap-3 font-bold text-blue-100 text-xl md:text-2xl mb-6 relative z-10">
                                    <div className="p-2 bg-blue-500/20 rounded-lg border border-blue-500/30 shadow-glow-sm">
                                        <Icon name="Timer" size={22} className="text-blue-400" />
                                    </div>
                                    æœ¬é€±åŸ·è¡Œé‡é»
                                    <span className="text-sm font-bold text-blue-300 bg-blue-500/10 border border-blue-500/20 px-3 py-1 rounded-full ml-auto md:ml-2 backdrop-blur-md">
                                        {stats.activeTasks.length} é …é€²è¡Œä¸­
                                    </span>
                                </h3>
                                <div className="space-y-4 relative z-10">
                                    {stats.activeTasks.length === 0 ? (
                                        <div className="text-base text-slate-300 font-bold italic py-8 text-center bg-white/5 rounded-xl border border-dashed border-white/10">ç›®å‰ç„¡ç·Šæ€¥å¾…è¾¦äº‹é …</div>
                                    ) : (
                                        stats.activeTasks.map(task => {
                                            // UPDATED: Use helper to calculate day difference correctly
                                            const daysLeft = getDaysDiff(task.dateEnd, currentDate);
                                            return <ActionCard key={task.id} task={task} daysLeft={daysLeft} onToggle={toggleTask} />;
                                        })
                                    )}
                                </div>
                            </div>

                            <div className="glass-panel p-5 md:p-6 rounded-2xl flex flex-col">
                                <h3 className="flex items-center gap-3 font-bold text-slate-200 text-xl md:text-2xl mb-6">
                                    <div className="p-2 bg-white/5 rounded-lg border border-white/10">
                                        <Icon name="ArrowRight" size={22} className="text-slate-400" />
                                    </div>
                                    å¾ŒçºŒé å‚™ä»»å‹™
                                </h3>
                                <div className="space-y-4 flex-1">
                                    {stats.upcomingTasks.length === 0 ? <p className="text-base text-slate-500">ç„¡å¾ŒçºŒä»»å‹™</p> : 
                                        stats.upcomingTasks.map(task => {
                                            // UPDATED: Use helper
                                            const daysToStart = getDaysDiff(task.dateStart, currentDate);
                                            return (
                                                <div key={task.id} className="flex items-center gap-5 p-4 rounded-xl bg-white/5 hover:bg-white/10 border border-transparent hover:border-white/10 transition-all">
                                                    <div className="w-14 text-center shrink-0 flex flex-col justify-center bg-black/20 rounded-lg py-2 border border-white/5">
                                                        <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider">å†é</div>
                                                        <div className="text-xl md:text-2xl font-bold text-slate-300 leading-none my-0.5">{daysToStart}</div>
                                                        <div className="text-[10px] text-slate-400 font-bold">å¤©</div>
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="font-bold text-slate-200 text-lg md:text-xl truncate">{task.taskName}</div>
                                                        <div className="text-sm text-slate-300 font-bold mt-1 flex items-center gap-2">
                                                            <span className="w-1.5 h-1.5 rounded-full bg-slate-600"></span>
                                                            é è¨ˆå•Ÿå‹•ï¼š{task.deadlineDisplay.split('~')[0]}
                                                        </div>
                                                    </div>
                                                    {task.type === 'submission' && <Icon name="FileInput" size={18} className="text-indigo-400" />}
                                                </div>
                                            );
                                        })
                                    }
                                </div>
                                <div className="mt-6 pt-4 border-t border-white/10 text-center">
                                    <button onClick={() => { if(stats.upcomingTasks.length > 0) { setActiveStage(stats.upcomingTasks[0].stage); const element = document.getElementById('task-list'); element?.scrollIntoView({ behavior: 'smooth' }); }}} className="text-sm md:text-base text-blue-400 font-bold hover:text-blue-300 flex items-center justify-center gap-1 py-2 w-full hover:bg-white/5 rounded-lg transition-colors">
                                        å‰å¾€è©²éšæ®µæª¢è¦–è©³æƒ… <Icon name="ChevronRight" size={16} />
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Main Content */}
                        <div id="task-list" className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            {/* Sidebar Stats (Desktop Only) */}
                            <div className={`lg:col-span-3 space-y-6 ${isMobileMenuOpen ? 'block' : 'hidden lg:block'}`}>
                                <div className="glass-panel p-6 rounded-2xl">
                                    <h3 className="text-base font-bold text-slate-400 mb-4 flex items-center gap-2 uppercase tracking-wider">
                                        <Icon name="PieChart" size={18} /> æ•´é«”å®Œæˆç‡
                                    </h3>
                                    <div className="relative pt-2">
                                        <div className="flex items-end justify-between mb-3">
                                            <span className="text-4xl font-bold text-slate-100">{stats.progress}%</span>
                                            <span className="text-sm text-slate-400 font-bold mb-1.5 font-mono">{stats.completed}/{stats.total} é …ç›®</span>
                                        </div>
                                        <div className="w-full bg-slate-700/30 rounded-full h-3 backdrop-blur-sm">
                                            <div className="bg-blue-600 h-3 rounded-full transition-all duration-700 shadow-glow-sm" style={{ width: `${stats.progress}%` }}></div>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-8 pt-6 border-t border-white/10">
                                        <h4 className="text-sm font-bold text-slate-400 mb-4 flex items-center gap-2 uppercase tracking-wider">
                                            <Icon name="Send" size={16} /> å­¸æœƒå›å‚³é€²åº¦
                                        </h4>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-base text-slate-300 font-bold">æª¢æ ¸è¡¨èˆ‡åå–®</span>
                                            <span className="text-base font-bold text-emerald-400">{stats.submissionProgress}%</span>
                                        </div>
                                        <div className="w-full bg-slate-700/30 rounded-full h-2.5 backdrop-blur-sm">
                                            <div className="bg-emerald-500 h-2.5 rounded-full transition-all duration-700 shadow-glow-sm" style={{ width: `${stats.submissionProgress}%` }}></div>
                                        </div>
                                    </div>

                                    {/* Export Buttons - Only visible to Admin */}
                                    {isAdmin && (
                                        <div className="mt-8 pt-6 border-t border-white/10 space-y-3 animate-fade-in">
                                            <div className="text-xs font-bold text-indigo-400 mb-2 uppercase tracking-wider">ç®¡ç†å“¡åŠŸèƒ½</div>
                                            <button onClick={handleSyncClick} className="w-full flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white py-2.5 rounded-lg text-sm font-bold transition-all shadow-glow border border-indigo-500/50 hover:scale-[1.02]">
                                                <Icon name="UploadCloud" size={16} /> â˜ï¸ åŒæ­¥è‡³ Google Sheet
                                            </button>
                                            <button onClick={copyForGoogleSheets} className="w-full flex items-center justify-center gap-2 bg-white/5 hover:bg-white/10 text-slate-300 py-2.5 rounded-lg text-sm font-bold transition-colors border border-white/10">
                                                <Icon name="Copy" size={16} /> ğŸ“‹ è¤‡è£½è³‡æ–™ (Excel/Sheet)
                                            </button>
                                            <button onClick={downloadCSV} className="w-full flex items-center justify-center gap-2 bg-white/5 hover:bg-white/10 text-slate-300 py-2.5 rounded-lg text-sm font-bold transition-colors border border-white/10">
                                                <Icon name="Download" size={16} /> ğŸ“¥ ä¸‹è¼‰ CSV å‚™ä»½
                                            </button>
                                        </div>
                                    )}
                                </div>

                                <nav className="glass-panel rounded-2xl overflow-hidden hidden md:block">
                                    <div className="p-5 bg-white/5 border-b border-white/10">
                                        <h3 className="font-bold text-slate-200 text-lg flex items-center gap-2">
                                            <Icon name="ListTodo" size={20} /> éšæ®µå°èˆª
                                        </h3>
                                    </div>
                                    <div className="divide-y divide-white/5">
                                        <div className="bg-slate-900/50 px-5 py-2 text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-white/5">ğŸ“‹ å®˜æ–¹è©¦å‹™æœŸç¨‹</div>
                                        {STAGES.filter(s => s.category === 'official').map((stage) => {
                                            const isActive = activeStage === stage.id;
                                            
                                            return (
                                                <button key={stage.id} onClick={() => { setActiveStage(stage.id); setIsMobileMenuOpen(false); }} className={`w-full text-left p-5 flex items-center justify-between transition-all hover:bg-white/5 ${isActive ? 'bg-blue-500/10 border-l-4 border-blue-500' : 'border-l-4 border-transparent'}`}>
                                                    <div>
                                                        <div className={`text-base md:text-lg font-bold ${isActive ? 'text-blue-400' : 'text-slate-300'}`}>
                                                            {stage.title}
                                                        </div>
                                                        <div className="text-sm text-slate-500 font-bold mt-1.5 flex items-center gap-2">
                                                            <span>{stage.period}</span>
                                                        </div>
                                                    </div>
                                                    {isActive && <Icon name="ChevronRight" size={20} className="text-blue-500" />}
                                                </button>
                                            );
                                        })}
                                        
                                        <div className="bg-slate-900/50 px-5 py-2 text-xs font-bold text-indigo-400 uppercase tracking-wider border-y border-white/5 mt-2">ğŸ¥ é™¢å…§ UGY ç‰¹è¨“</div>
                                        {STAGES.filter(s => s.category === 'internal').map((stage) => {
                                            const isActive = activeStage === stage.id;
                                            
                                            return (
                                                <button key={stage.id} onClick={() => { setActiveStage(stage.id); setIsMobileMenuOpen(false); }} className={`w-full text-left p-5 flex items-center justify-between transition-all hover:bg-white/5 ${isActive ? 'bg-indigo-500/10 border-l-4 border-indigo-500' : 'border-l-4 border-transparent'}`}>
                                                    <div>
                                                        <div className={`text-base md:text-lg font-bold ${isActive ? 'text-indigo-400' : 'text-slate-300'}`}>
                                                            {stage.title}
                                                        </div>
                                                        <div className="text-sm text-slate-500 font-bold mt-1.5 flex items-center gap-2">
                                                            <span>{stage.period}</span>
                                                        </div>
                                                    </div>
                                                    {isActive && <Icon name="ChevronRight" size={20} className="text-indigo-500" />}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </nav>
                            </div>

                            {/* Task List */}
                            <div className="lg:col-span-9 flex flex-col gap-6">
                                <div className="glass-panel p-5 md:p-6 rounded-2xl flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <div className="w-full md:w-auto">
                                        {/* Mobile Stage Selector (Only Visible on Mobile) */}
                                        <div className="md:hidden w-full mb-4">
                                            <label className="text-xs text-slate-400 uppercase font-bold mb-1.5 block">åˆ‡æ›éšæ®µ</label>
                                            <div className="relative">
                                                <select 
                                                    value={activeStage} 
                                                    onChange={(e) => setActiveStage(Number(e.target.value))}
                                                    className="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3 outline-none focus:border-blue-500 dark-select appearance-none shadow-inner font-bold"
                                                >
                                                    <optgroup label="ğŸ“‹ å®˜æ–¹è©¦å‹™æœŸç¨‹">
                                                        {STAGES.filter(s => s.category === 'official').map(stage => (
                                                            <option key={stage.id} value={stage.id}>{stage.title}</option>
                                                        ))}
                                                    </optgroup>
                                                    <optgroup label="ğŸ¥ é™¢å…§ UGY ç‰¹è¨“">
                                                        {STAGES.filter(s => s.category === 'internal').map(stage => (
                                                            <option key={stage.id} value={stage.id}>{stage.title}</option>
                                                        ))}
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </div>

                                        <h2 className={`text-2xl md:text-3xl font-bold hidden md:block drop-shadow-md ${STAGES.find(s => s.id === activeStage)?.category === 'internal' ? 'text-indigo-400' : 'text-white'}`}>
                                            {STAGES.find(s => s.id === activeStage)?.title}
                                        </h2>
                                        <p className="text-base md:text-lg text-slate-300 font-bold mt-2 flex items-center gap-2 flex-wrap">
                                            {activeStage === 99 ? 'é™¢å…§è‡ªè¨‚è¡Œç¨‹' : 'æª¢æ ¸è¡¨å›å‚³æˆªæ­¢æ—¥ï¼š'}
                                            <span className={`font-mono font-bold px-3 py-1 rounded backdrop-blur-sm ${activeStage === 99 ? 'text-indigo-300 bg-indigo-500/20 border border-indigo-500/30' : 'text-rose-300 bg-rose-500/20 border border-rose-500/30'}`}>
                                                {STAGES.find(s => s.id === activeStage)?.returnDate}
                                            </span>
                                        </p>
                                    </div>
                                    <div className="flex bg-black/20 p-1.5 rounded-xl self-end md:self-center backdrop-blur-sm border border-white/5">
                                        <button onClick={() => setFilter('all')} className={`px-5 py-2.5 text-base font-bold rounded-lg transition-all ${filter === 'all' ? 'bg-white/10 text-white shadow-sm border border-white/10' : 'text-slate-400 hover:text-slate-200 hover:bg-white/5'}`}>å…¨éƒ¨</button>
                                        <button onClick={() => setFilter('pending')} className={`px-5 py-2.5 text-base font-bold rounded-lg transition-all ${filter === 'pending' ? 'bg-white/10 text-white shadow-sm border border-white/10' : 'text-slate-400 hover:text-slate-200 hover:bg-white/5'}`}>æœªå®Œæˆ</button>
                                    </div>
                                </div>

                                <div className="glass-panel rounded-2xl overflow-hidden">
                                    <div className="hidden md:grid grid-cols-12 gap-4 bg-white/5 border-b border-white/10 p-4 text-sm font-bold text-slate-400 uppercase tracking-wider backdrop-blur-md">
                                        <div className="col-span-1 text-center">ç‹€æ…‹</div>
                                        <div className="col-span-1">é …æ¬¡</div>
                                        <div className="col-span-5">å·¥ä½œé …ç›®</div>
                                        <div className="col-span-2">é¡å‹</div>
                                        <div className="col-span-2">æœŸé™</div>
                                        <div className="col-span-1 text-center">é€²åº¦</div>
                                    </div>

                                    <div className="divide-y divide-white/5">
                                        {tasks.filter(t => t.stage === activeStage).filter(t => filter === 'all' || !t.completed).map(task => {
                                            const status = getStatusLabel(task);
                                            const lightClass = getTrafficLight(task);
                                            const isInternal = task.stage === 99;
                                            
                                            return (
                                                <div key={task.id} className={`p-5 md:p-4 grid grid-cols-1 md:grid-cols-12 gap-3 md:gap-4 items-center transition-colors hover:bg-white/5 border-l-4 relative ${isInternal ? 'border-indigo-500' : 'border-slate-600'}`}>
                                                    
                                                    {/* Traffic Light Visual - Desktop Column 1 */}
                                                    <div className="hidden md:flex md:col-span-1 justify-center items-center">
                                                        <div className={`w-3 h-3 rounded-full ${lightClass}`} title={status.text}></div>
                                                    </div>

                                                    {/* Compact Mobile Layout */}
                                                    <div className="md:hidden relative pl-3 w-full">
                                                        {/* Color Strip based on status */}
                                                        <div className={`absolute left-0 top-0 bottom-0 w-1 rounded-l ${lightClass.replace('w-3 h-3 rounded-full', '').replace('shadow-[0_0_10px_rgba(16,185,129,0.5)]', '')}`}></div>
                                                        
                                                        <div className="flex justify-between items-start gap-3">
                                                            <div className="flex-1">
                                                                 <div className="flex items-start gap-3">
                                                                    <button onClick={() => toggleTask(task.id)} className={`mt-0.5 shrink-0 ${isAdmin ? 'text-slate-500 hover:text-blue-400' : 'text-slate-600'}`}>
                                                                        {task.completed ? <Icon name="CheckCircle2" className="text-emerald-400 drop-shadow-md" size={26}/> : <Icon name="CheckCircle2" size={26}/>}
                                                                    </button>
                                                                    <div className="w-full">
                                                                         <div className="flex justify-between items-start w-full mb-1">
                                                                             <h4 className={`text-lg font-bold leading-snug mr-2 ${task.completed ? 'line-through text-slate-500' : 'text-slate-100'}`}>
                                                                                {task.taskName}
                                                                             </h4>
                                                                             {/* Status Badge moved to right of title */}
                                                                             <span className={`shrink-0 inline-block px-2 py-0.5 rounded text-xs font-bold border ${status.class}`}>{status.text}</span>
                                                                         </div>
                                                                         
                                                                         <div className="flex flex-wrap items-center gap-2 mt-2 text-sm text-slate-300 font-bold">
                                                                             <span className="bg-white/10 px-1.5 py-0.5 rounded text-xs font-mono border border-white/10">{task.seq}</span>
                                                                             <span className="flex items-center gap-1 font-mono text-xs bg-black/20 px-2 py-1 rounded border border-white/5 text-slate-300"><Icon name="Calendar" size={12}/> {task.deadlineDisplay}</span>
                                                                             {task.type === 'submission' && <span className="text-indigo-300 bg-indigo-500/20 px-1.5 py-0.5 rounded border border-indigo-500/30 flex items-center gap-1 text-xs"><Icon name="FileInput" size={12}/> éœ€å›å‚³</span>}
                                                                             {task.type === 'training' && <span className="text-purple-300 bg-purple-500/20 px-1.5 py-0.5 rounded border border-purple-500/30 flex items-center gap-1 text-xs"><Icon name="GraduationCap" size={12}/> è¨“ç·´</span>}
                                                                         </div>
                                                                    </div>
                                                                 </div>
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Mobile Notes Section */}
                                                        <div className="mt-3 ml-10 space-y-2">
                                                            {task.note && !task.completed && (
                                                                <div className="text-sm text-amber-300 font-bold flex items-center gap-2 bg-amber-500/10 p-2 rounded border border-amber-500/20">
                                                                    <Icon name="AlertCircle" size={14} className="shrink-0"/> {task.note}
                                                                </div>
                                                            )}
                                                            
                                                            {/* Mobile User Note */}
                                                            {isAdmin && (
                                                                <div className="flex items-center gap-2 mt-1 bg-black/20 p-1.5 rounded border border-white/5">
                                                                    <Icon name="Edit" size={12} className="text-slate-500"/>
                                                                    <input 
                                                                        type="text" 
                                                                        className="bg-transparent border-0 focus:ring-0 outline-none text-sm text-blue-200 w-full placeholder-slate-600 py-0 font-bold"
                                                                        placeholder="æ–°å¢åŸ·è¡Œç­†è¨˜..."
                                                                        value={task.userNote || ''}
                                                                        onChange={(e) => updateUserNote(task.id, e.target.value)}
                                                                    />
                                                                </div>
                                                            )}
                                                            {!isAdmin && task.userNote && (
                                                                <p className="text-sm text-blue-300 italic font-bold border-l-2 border-blue-500/30 pl-2 py-1">{task.userNote}</p>
                                                            )}
                                                        </div>
                                                    </div>

                                                    {/* Desktop: Seq */}
                                                    <div className="hidden md:block md:col-span-1 text-slate-400 font-bold font-mono text-base">{task.seq}</div>

                                                    {/* Desktop: Name & Note */}
                                                    <div className="hidden md:block md:col-span-5">
                                                        <div className="flex items-center gap-3">
                                                            <button onClick={() => toggleTask(task.id)} className={`shrink-0 ${isAdmin ? 'text-slate-500 hover:text-blue-400 cursor-pointer' : 'text-slate-600 cursor-not-allowed opacity-50'}`}>
                                                                {task.completed ? <Icon name="CheckCircle2" className="text-emerald-400 drop-shadow-md" size={24}/> : <Icon name="CheckCircle2" size={24}/>}
                                                            </button>
                                                            <div className={`text-lg font-bold ${task.completed ? 'line-through text-slate-600' : 'text-slate-200'}`}>{task.taskName}</div>
                                                        </div>
                                                        {task.note && !task.completed && <div className="text-sm font-bold text-amber-300 mt-1 flex items-center gap-1.5 ml-9"><Icon name="AlertCircle" size={14}/> {task.note}</div>}
                                                        
                                                        {/* User Note Input (Desktop) */}
                                                        {(isAdmin || task.userNote) && (
                                                            <div className="mt-2 ml-9">
                                                                {isAdmin ? (
                                                                    <div className="flex items-center gap-2 group/input">
                                                                        <Icon name="Edit" size={14} className="text-slate-600 group-hover/input:text-slate-400 transition-colors"/>
                                                                        <input 
                                                                            type="text" 
                                                                            className="bg-transparent border-b border-white/10 focus:border-blue-500 outline-none text-sm text-blue-200 font-bold w-full placeholder-slate-700 hover:border-white/20 transition-colors"
                                                                            placeholder="æ–°å¢åŸ·è¡Œç­†è¨˜..."
                                                                            value={task.userNote || ''}
                                                                            onChange={(e) => updateUserNote(task.id, e.target.value)}
                                                                        />
                                                                    </div>
                                                                ) : (
                                                                    <p className="text-sm font-bold text-blue-300 italic border-l-2 border-white/10 pl-2">{task.userNote}</p>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                    
                                                    {/* Desktop Type */}
                                                    <div className="hidden md:flex md:col-span-2 pl-0 flex-wrap gap-2 mb-2 md:mb-0">
                                                        {task.type === 'submission' && <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg bg-indigo-500/20 text-indigo-300 text-sm font-bold border border-indigo-500/30"><Icon name="FileInput" size={14}/> ç¹³äº¤å­¸æœƒ</span>}
                                                        {task.type === 'milestone' && <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg bg-purple-500/20 text-purple-300 text-sm font-bold border border-purple-500/30"><Icon name="Flag" size={14}/> é‡è¦æ™‚ç¨‹</span>}
                                                        {task.type === 'task' && <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg bg-slate-700/50 text-slate-300 text-sm font-bold border border-slate-600/50"><Icon name="Clock" size={14}/> ä¸€èˆ¬ä½œæ¥­</span>}
                                                        {task.type === 'training' && <span className="inline-flex items-center gap-1.5 px-3 py-1 rounded-lg bg-indigo-600/20 text-indigo-300 text-sm font-bold border border-indigo-500/30"><Icon name="GraduationCap" size={14}/> é™¢å…§è¨“ç·´</span>}
                                                    </div>

                                                    {/* Desktop Deadline */}
                                                    <div className="hidden md:flex md:col-span-2 text-base font-bold font-mono text-slate-300 items-center gap-2 mb-2 md:mb-0">
                                                        <Icon name="Calendar" size={16}/> {task.deadlineDisplay}
                                                    </div>

                                                    {/* Desktop Status Text */}
                                                    <div className="hidden md:block md:col-span-1 md:text-center">
                                                        <span className={`inline-block px-3 py-1 rounded-full text-sm font-bold border ${status.class}`}>{status.text}</span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                        {tasks.filter(t => t.stage === activeStage).length === 0 && <div className="p-16 text-center text-slate-500 font-bold"><p className="text-lg">æ­¤éšæ®µå°šç„¡ä»»å‹™è³‡æ–™</p></div>}
                                    </div>
                                </div>
                                
                                <div className="glass-panel border-white/10 rounded-xl p-5 text-sm md:text-base text-slate-400 font-bold flex items-start gap-3 shadow-sm">
                                    <Icon name="Cloud" size={20} className="mt-0.5 shrink-0 text-indigo-400" />
                                    <p className="leading-relaxed"><span className="font-bold text-slate-200">æœ¬åœ°å­˜æª”ä¸­ï¼š</span> æ‚¨çš„é€²åº¦æœƒè‡ªå‹•å„²å­˜æ–¼æ­¤ç€è¦½å™¨ä¸­ã€‚æ¨™ç¤º <span className="inline-flex items-center gap-1 mx-1.5 px-1.5 py-0.5 rounded bg-indigo-500/20 text-indigo-300 font-bold border border-indigo-500/30 align-middle text-xs"><Icon name="FileInput" size={12}/> ç¹³äº¤å­¸æœƒ</span> ä¹‹é …ç›®ç‚ºå­¸æœƒæª¢æ ¸é‡é»ï¼Œè«‹å„ªå…ˆè™•ç†ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Footer */}
                    <footer className="w-full max-w-7xl mx-auto px-4 md:px-6 py-6 border-t border-white/5 flex justify-end text-right">
                        <div className="text-slate-500 text-sm font-bold">
                            å¥‡ç¾é†«é™¢ è‡¨åºŠæŠ€èƒ½ä¸­å¿ƒ è£½
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
